import{j as t,F as S,a9 as z,Q as O,a as v}from"./vendor-font-awesome-fb8PRCmj.js";import{u as R,C,c as q,H as W,h as N,q as i}from"./index-lBioDFl4.js";import{I as G}from"./InputArea-Dr2i9MUp.js";import{B as b}from"./Button-C3YJ6iVm.js";import{B as J}from"./Badge-BYGKmlU7.js";import{u as U,a as D}from"./vendor-states-CBI6bQG0.js";import{C as X}from"./Post-Bz7304CQ.js";import{b as Y}from"./formatDate-HarhDgxf.js";import{u as Z,a as ee,o as te,n as E,s as re}from"./vendor-forms-CXz_4OM6.js";import{y as Q}from"./index-CcAK1yoR.js";import{L as A}from"./vendor-react-Cx4ePrNi.js";import"./InputLabel-DqjUQIAl.js";import"./posts.service-CMgQtzql.js";import"./Subtitle-Bx186bz3.js";import"./Divider-BLVUVjaf.js";import"./capitalizeWords-C3LnHOhm.js";import"./useDocumentTitle-CWGRdlYI.js";import"./appMeta-B1yHDSiB.js";import"./RequirePolicy-BlAHeWT0.js";import"./ExternalLinkButton-DT1kjBsT.js";import"./FoldoutIcon-C72KZmKq.js";import"./subscription-iDNfJ_xm.js";import"./usePageLog-CpyrOzkW.js";const se=({id:r,authorId:m,authorName:n,createdAt:c,replyId:u,replyName:l,content:h,highlighted:j,onReplyClick:f,onRemoveClick:p,onResponseClick:s})=>{const{isAuthenticated:x,user:w}=R();return t.jsx("div",{id:r,className:"flex flex-col gap-2",children:t.jsxs(C,{className:q("px-4 py-2 dark:bg-mono-700/40 flex flex-col gap-2 transition-all duration-500",{"border-primary-500 dark:border-primary-500":j}),children:[t.jsx("div",{className:"flex flex-row gap-4 items-center",children:t.jsxs(W,{className:"text-base flex flex-row gap-2 items-center",children:[n,t.jsx("p",{className:"text-xs text-mono-500",children:c})]})}),t.jsx("div",{className:"text-subbase/6 flex flex-row gap-2",children:t.jsxs("p",{children:[l&&u&&t.jsxs("b",{onClick:s,className:"text-primary-500 mr-1 cursor-pointer select-none",children:["@",l]}),u&&!l&&t.jsx("b",{className:"text-mono-500 mr-1 select-none",children:"@Deleted"}),h]})}),x&&t.jsxs("div",{className:"flex flex-row gap-2",children:[t.jsxs(b,{className:"text-ssm px-3 py-2 flex flex-row gap-2 items-center",onClick:f,variant:"link",children:[t.jsx(S,{icon:z}),"Reply"]}),w?.id===m&&t.jsxs(b,{className:"text-ssm px-3 py-2 flex flex-row gap-2 items-center",onClick:p,variant:"link",children:[t.jsx(S,{icon:O}),"Remove"]})]}),t.jsx("div",{})]})})};function ae(r){return{id:r.id,postId:r.post_id,replyId:r.reply_id,authorName:r.username,authorId:r.author_id,createdAt:r.created_at,content:r.content}}async function oe(r){const m=await N(),{data:n,error:c}=await m.schema("blog").from("comments_with_author").select("*").eq("post_id",r).order("created_at",{ascending:!1});if(c)throw c;if(!n)throw new Error("No post data.");return n.map(ae)}async function ne(r,m,n){const c=await N(),{data:u,error:l}=await c.schema("blog").from("comments").insert({post_id:r,content:m,reply_id:n}).select("id").single();if(l)throw l;return u?.id}async function ie(r){const m=await N(),{error:n}=await m.schema("blog").rpc("delete_comment",{comment_id:r});if(n)throw n}const me=te({postId:E(),content:re().min(1,{message:"Comment text is required"}),replyId:E().optional()}),Ae=({postId:r,className:m})=>{const{isAuthenticated:n,user:c,username:u}=R(),[l,h]=v.useState(),[j,f]=v.useState(null),p=v.useRef(null),s=["comments",r],{data:x,isLoading:w}=U({queryKey:s,queryFn:()=>oe(r),staleTime:1e3*60*5,retry:2,refetchInterval:1e3*60*5}),{handleSubmit:I,formState:{errors:F,isValid:B},register:M,reset:y,setValue:k}=Z({resolver:ee(me),defaultValues:{postId:r},mode:"onSubmit"});v.useEffect(()=>{y({postId:r})},[r,y]);const g=D({mutationFn:async e=>{try{await ne(e.postId,e.content,e.replyId)}catch(a){console.error(a)}},onMutate:async e=>{await i.cancelQueries({queryKey:s});const a=i.getQueryData(s),o={id:Date.now(),postId:r,authorId:c?.id??"",content:e.content,authorName:u??"Who are you?",createdAt:new Date().toISOString()};return i.setQueryData(s,d=>d?[o,...d]:[o]),{previousComments:a,optimisticCommentId:o.id}},onError:(e,a,o)=>{o?.previousComments!==void 0&&i.setQueryData(s,o.previousComments),Q.error("Error adding comment, try again later")},onSettled:()=>i.invalidateQueries({queryKey:s})}),P=D({mutationFn:async e=>{await ie(e)},onMutate:async e=>{await i.cancelQueries({queryKey:s});const a=i.getQueryData(s);return i.setQueryData(s,o=>o?.filter(d=>d.id!==e)||[]),{previousComments:a}},onError:(e,a,o)=>{o?.previousComments&&i.setQueryData(s,o.previousComments),Q.error("Error deleting comment, try again later")},onSettled:()=>i.invalidateQueries({queryKey:s})}),{ref:T,...V}=M("content"),K=e=>{e!==void 0&&(f(e),document.getElementById(`comment-${e}`)?.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{f(null)},3e3))},L=()=>{p.current&&(p.current.scrollIntoView({behavior:"smooth",block:"center"}),p.current.focus())},H=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),I(a=>{g.mutate(a),h(void 0),y()})())};if(w)return t.jsx(X,{});const _=x?.find(e=>e.id===l)?.authorName;return t.jsxs("div",{className:q("flex flex-col gap-4",m),children:[n?t.jsx("form",{onSubmit:I(async e=>{g.mutate(e),y()}),children:t.jsxs(C,{className:"flex flex-col gap-5 p-3",children:[t.jsx(G,{id:"content",error:F.content,...V,ref:e=>{T(e),p.current=e},placeholder:"Share your thoughts...",onKeyDown:H}),t.jsxs("div",{className:"flex flex-row gap-2 justify-end",children:[_&&t.jsxs(J,{className:"max-w-xs truncate break-all cursor-pointer select-none",variant:"gray",onClick:()=>{h(void 0),k("replyId",void 0)},children:[_,t.jsx("span",{children:"Ã—"})]}),t.jsx(b,{disabled:!B||g.isPending,className:"grow sm:grow-0",variant:"submit",size:"medium",children:g.isPending?"Posting...":"Post"})]})]})}):t.jsx(C,{className:"p-6 text-center",children:t.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["Please ",t.jsx(A,{to:"/login",className:"text-primary-600 dark:text-primary-400 underline",children:"log in"})," or ",t.jsx(A,{to:"/register",className:"text-primary-600 dark:text-primary-400 underline",children:"sign up"})," to add comments."]})}),t.jsx("div",{className:"flex flex-col gap-2",children:x&&x.map(e=>{const a=x?.find($=>$.id===e.replyId),o=e.replyId?a?.authorName??void 0:void 0,d=e.replyId?a?.id??-1:void 0;return t.jsx(se,{id:`comment-${e.id}`,authorId:e.authorId,authorName:e.authorName,replyId:d,replyName:o,createdAt:Y(e.createdAt),content:e.content,onReplyClick:()=>{h(e.id),k("replyId",e.id),L()},onResponseClick:()=>K(d),onRemoveClick:()=>P.mutate(e.id),highlighted:j===e.id},e.id)})})]})};export{Ae as default};
