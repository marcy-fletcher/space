import{j as e,F as p,t as T,O as L,o as V,a as z,M as R,Q as O,f as W,Y,g as G}from"./vendor-font-awesome-fb8PRCmj.js";import{h as f,c as u,u as M,q as g,C as N,H as w,d as k,E as I,l as C,e as S}from"./index-DVJIb8Cr.js";import{P as J}from"./PageHeader-1TgteFVd.js";import{B as v}from"./Button-85dFU1bc.js";import{I as X}from"./InputField-DN-1BlyW.js";import{S as E}from"./Subtitle-BGRHiaIL.js";import{a as b,u as Z}from"./vendor-states-BrjWHaJB.js";import{B as $}from"./Badge-KlCDyamb.js";import{a as ee}from"./formatDate-HarhDgxf.js";import{y as m}from"./index-BpgUN2na.js";import{u as _,a as A,o as Q,g as se,_ as ae}from"./vendor-forms-CXz_4OM6.js";import{S as re}from"./subscription-iDNfJ_xm.js";import{I as te,a as ie}from"./InputLabel-DfrZCBfn.js";import{I as ne}from"./InputIcon-BXu-Qsav.js";import{u as oe}from"./useDocumentTitle-1xR-jf3b.js";import{u as ce}from"./usePageLog-Cwne7LeP.js";import"./vendor-react-Cx4ePrNi.js";async function de(){const s=await f(),a=(await s.auth.getUser()).data.user;if(!a)throw new Error("Unauthorized");const{data:r,error:o}=await s.schema("subscriptions").from("invites_with_details").select("*").eq("created_by",a.id).order("created_at",{ascending:!1});if(o)throw o;return r?r.map(i=>({code:i.invite_key,createdBy:i.created_by,usedBy:i.invite_user_username,subscriptionName:i.subscription_tier_name,createdAt:i.created_at,usedAt:i.used_at})):[]}async function le(s){const a=await f(),{error:r}=await a.schema("subscriptions").rpc("use_invite",{p_invite_key:s});if(r)throw r.message}async function me(s){let a=-1;if(s==="high-priest")a=2;else if(s==="cult-leader")a=3;else throw new Error("Unable to create invite");const r=await f(),{error:o}=await r.schema("subscriptions").rpc("create_invite",{p_subscription_tier_id:a});if(o)throw o.message}async function ue(s){const a=await f(),{error:r}=await a.schema("subscriptions").from("invites").delete().eq("invite_key",s);if(r)throw r.message}const U=({code:s,className:a})=>e.jsxs("div",{className:u("flex items-center",a),children:[e.jsx("div",{className:"flex items-center justify-center rounded-lg min-w-10 w-10 h-10 bg-gray-200 dark:bg-gray-700 shrink-0",children:e.jsx(p,{icon:T})}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("div",{className:"text-base font-medium truncate",children:s}),e.jsx("div",{className:"text-xs text-gray-500",children:"Click copy to use"})]})]}),B=({used:s,className:a})=>e.jsxs($,{variant:s?"green":"gray",className:u("flex items-center gap-1",a),children:[e.jsx(p,{icon:s?L:V}),s?"Used":"Available"]}),K=({usedBy:s,className:a})=>e.jsx("div",{className:u("flex items-center",a),children:s?e.jsx("span",{className:"text-sm truncate",children:s}):e.jsx("div",{className:"text-gray-500",children:"—"})}),P=({name:s,className:a})=>e.jsx("div",{className:u("flex items-center",a),children:e.jsx("span",{className:"text-sm truncate",children:s})}),q=({usedAt:s,className:a})=>{const r=s?ee(s):null;return e.jsx("div",{className:u("flex flex-col justify-center",a),children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm",children:r.date}),e.jsx("div",{className:"text-xs text-gray-500",children:r.time})]}):e.jsx("div",{className:"text-gray-500",children:"—"})})},F=({code:s,className:a})=>{const{user:r}=M(),[o,i]=z.useState(!1),y=async()=>{try{await navigator.clipboard.writeText(s),i(!0),setTimeout(()=>i(!1),2e3)}catch(n){console.error("Failed to copy code: ",n)}},l=["invites",r?.id],{mutate:h,isPending:x}=b({mutationFn:ue,onMutate:async n=>{await g.cancelQueries({queryKey:l});const c=g.getQueryData(l);return g.setQueryData(l,d=>d?.filter(j=>j.code!==n)||[]),{previousInvites:c}},onError:(n,c,d)=>{d?.previousInvites&&g.setQueryData(l,d.previousInvites),m.error("Error deleting invite, try again later")},onSuccess:async()=>{await g.invalidateQueries({queryKey:l})}});return e.jsxs("div",{className:u("flex items-center gap-2",a),children:[e.jsxs(v,{variant:"submit",size:"small",onClick:y,"aria-label":"Copy invite code",children:[e.jsx(p,{className:"mr-2",icon:R}),o?"Code copied!":"Copy code"]}),e.jsx(v,{variant:"secondary",size:"small",disabled:x,onClick:()=>h(s),"aria-label":"Delete invite code",children:x?e.jsx(p,{icon:W,spin:!0}):e.jsx(p,{icon:O})})]})},xe=({invite:s})=>e.jsxs("div",{className:"rounded-lg border md:rounded-none border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900/60 shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"hidden md:flex md:flex-col md:p-4 md:py-5 gap-4",children:[e.jsxs("div",{className:"grid md:grid-cols-12 md:gap-4",children:[e.jsx(U,{code:s.code,className:"col-span-4 gap-4 overflow-hidden"}),e.jsx(B,{used:!!s.usedAt,className:"col-span-2"}),e.jsx(K,{usedBy:s.usedBy,className:"col-span-2"}),e.jsx(P,{name:s.subscriptionName,className:"col-span-2"}),e.jsx(q,{usedAt:s.usedAt,className:"col-span-1"})]}),!s.usedAt&&e.jsx(F,{className:"col-span-2",code:s.code})]}),e.jsxs("div",{className:"md:hidden flex flex-col gap-4 p-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsx(U,{code:s.code,className:"gap-3 flex-1 min-w-0"}),e.jsx(B,{used:!!s.usedAt,className:"shrink-0"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Used by"}),e.jsx(K,{usedBy:s.usedBy})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Used at"}),e.jsx("div",{className:"font-medium",children:e.jsx(q,{usedAt:s.usedAt})})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4 text-sm",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Subscription"}),e.jsx(P,{name:s.subscriptionName})]})}),!s.usedAt&&e.jsx(F,{code:s.code})]})]}),pe=({id:s,label:a,icon:r,error:o,className:i,register:y,options:l,placeholder:h,required:x,...n})=>{const c=!!o;return e.jsxs("div",{className:u("relative",i),children:[a&&e.jsx(te,{hasError:c,className:"mb-2",isRequired:x,children:a}),e.jsxs("div",{className:"relative",children:[r&&e.jsx(ne,{icon:r,hasError:c}),e.jsxs("select",{id:s,...y?.(s),...n,defaultValue:n.value||"",className:u(`w-full px-4 py-3 rounded-lg font-sans focus:outline-none border 
                        border-mono-200 dark:border-mono-600
                        focus:ring-2 focus:ring-pink-400 focus:border-transparent 
                        bg-white dark:bg-mono-700 text-mono-900 dark:text-mono-100
                        appearance-none cursor-pointer
                        disabled:opacity-50 disabled:cursor-not-allowed`,c?`border-red-500 bg-red-50 dark:bg-red-900/20
                            focus:ring-2 focus:ring-red-400 focus:border-red-500`:"",r?"pl-10":""),children:[h&&e.jsx("option",{value:"",disabled:!0,className:"bg-white dark:bg-mono-700 text-mono-500",children:h}),l.map(d=>e.jsx("option",{value:d.value,className:"bg-white dark:bg-mono-700 text-mono-900 dark:text-mono-100",children:d.label},d.value))]}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("svg",{className:"w-5 h-5 text-mono-400 dark:text-mono-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]}),c&&e.jsx(ie,{errorMessage:o?.message??""})]})},ge=Q({key:se({message:"Invalid key format"}).min(1,{message:"Key is required"})}),he=Q({key:ae(re)}),ye=s=>{if(s.key==="acolyte")throw new Error("Rank is not sufficient");return s.key==="high-priest"?[{value:"high-priest",label:"The High Priest"}]:s.key==="cult-leader"||s.key==="goddess"||s.key==="deity"?[{value:"high-priest",label:"The High Priest"},{value:"cult-leader",label:"The Cult Leader"}]:[]},qe=()=>{const{register:s,setError:a,handleSubmit:r,reset:o,formState:{errors:i,isValid:y}}=_({resolver:A(ge),mode:"onChange"}),{register:l,handleSubmit:h}=_({resolver:A(he),mode:"onChange"});oe("Invites"),ce("Invites");const{user:x,subscription:n}=M(),{data:c}=Z({queryKey:["invites",x?.id],queryFn:()=>de(),staleTime:1e3*60*5,retry:2}),{mutate:d,isPending:j}=b({mutationFn:me,onSuccess:async()=>{m.success("Invite key was created!"),C(S.inviteCreated),await g.invalidateQueries({queryKey:["invites",x?.id]})},onError:t=>{k(I.inviteCreateError,{error:t}),typeof t=="string"?m.error(t):t instanceof Error?m.error(t.message):m.error("An unknown error occurred")}}),{mutate:D,isPending:H}=b({mutationFn:le,onSuccess:async()=>{m.success("Invite key was used!"),C(S.inviteUsed),await g.invalidateQueries({queryKey:["self-identity",x?.id]}),o()},onError:t=>{k(I.inviteKeyError,{error:t}),typeof t=="string"?(m.error(t),a("key",{message:t})):t instanceof Error?(m.error(t.message),a("key",{message:t.message})):(m.error("An unknown error occurred"),a("key",{message:"An unknown error occurred"}))}});return e.jsxs("div",{className:"container mx-auto px-4 max-w-4xl flex flex-col gap-4",children:[e.jsx(J,{title:"Subscription Management",subtitle:"Create or apply invite code"}),e.jsxs("div",{className:u("grid gap-4",n?.rank&&n.rank>1?"grid-cols-1 md:grid-cols-2 lg:grid-cols-3":"grid-cols-1"),children:[e.jsxs(N,{className:"lg:col-span-2 flex flex-col gap-4",children:[e.jsxs(w,{children:[e.jsx(p,{icon:T,className:"mr-2"}),"Use Invite Key"]}),e.jsx(E,{children:"Enter an invite key to apply new subscription to your account"}),e.jsx("div",{className:"px-4",children:e.jsxs("ul",{className:"list-disc text-sm text-mono-500",children:[e.jsx("li",{children:"Invite keys are case-sensitive"}),e.jsx("li",{children:"Each key can only be used once"})]})}),e.jsx("div",{className:"grow"}),i.key&&e.jsx("p",{className:"text-red-400",children:i.key.message}),e.jsxs("form",{className:"flex flex-row gap-4",onSubmit:r(async t=>D(t.key)),noValidate:!0,children:[e.jsx(X,{id:"key",register:s,className:"grow"}),e.jsx(v,{disabled:!y||H,className:"truncate max-h-12",variant:"submit",children:"Use"})]})]}),n?.rank&&n?.rank>1&&e.jsx("form",{className:"flex grow",noValidate:!0,onSubmit:h(async t=>d(t.key)),children:e.jsxs(N,{className:"flex grow flex-col gap-4",children:[e.jsxs(w,{children:[e.jsx(p,{icon:Y,className:"mr-2"}),"Create Invite Key"]}),e.jsx(E,{children:"Create an invite key with tier you want to share with user"}),e.jsx(pe,{id:"key",register:l,options:ye(n)}),e.jsx("div",{className:"grow"}),e.jsxs(v,{disabled:j,className:"h-12",variant:"submit",children:[e.jsx(p,{className:"mr-1",icon:G}),"Create invite"]})]})})]}),e.jsxs("div",{className:"p-0 overflow-hidden  md:rounded-2xl md:dark:bg-mono-800 md:shadow-lg md:border md:border-mono-200 md:dark:border-mono-700",children:[e.jsxs("div",{className:"hidden md:grid px-4 py-4 dark:border-b-mono-500 grid-cols-12 gap-4 text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider",children:[e.jsx("div",{className:"col-span-4",children:"Key"}),e.jsx("div",{className:"col-span-2",children:"Status"}),e.jsx("div",{className:"col-span-2",children:"Used by"}),e.jsx("div",{className:"col-span-2",children:"Subscription"}),e.jsx("div",{className:"col-span-2",children:"Used at"})]}),e.jsx("div",{className:"flex flex-col gap-4 md:gap-0 divide-x divide-gray-100 dark:divide-gray-800",children:c&&c.map(t=>e.jsx(xe,{invite:t},t.code))})]})]})};export{qe as default};
